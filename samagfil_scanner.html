<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SAMAGFIL — QR Scanner & Recorder</title>
  <style>
    :root{
      --blue:#0b3d91; --gold:#c59d2f; --bg:#f6f8fb;
      font-family: Inter, system-ui, Arial, sans-serif;
    }
    body{margin:0;background:var(--bg);color:#10212f;display:flex;flex-direction:column;align-items:center;padding:18px;}
    header{width:100%;max-width:980px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0;color:var(--blue)}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--blue);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:white;color:var(--blue);border:1px solid rgba(11,61,145,0.14)}
    .app{width:100%;max-width:980px;margin-top:16px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    .panel{background:white;border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(8,20,40,0.06)}
    #reader{width:100%;height:320px;border-radius:8px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;color:#fff}
    .fallback{display:flex;flex-direction:column;gap:8px}
    label{font-size:13px;color:#334}
    input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef3fb;font-size:13px;text-align:left}
    .small{font-size:12px;color:#567}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    @media (max-width:920px){.app{grid-template-columns:1fr;}.panel{padding:10px}}
  </style>
</head>
<body>
  <header>
    <h1>SAMAGFIL — QR Scanner & Recorder</h1>
    <div class="controls">
      <button id="startScanBtn">Start Camera</button>
      <button id="stopScanBtn" class="ghost" disabled>Stop</button>
      <button id="exportCsvBtn" class="ghost">Export CSV</button>
    </div>
  </header>

  <main class="app">
    <!-- Scanner panel -->
    <section class="panel">
      <div id="reader">Camera not started</div>
      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input type="file" id="fileInput" accept="image/*" />
        <button id="scanImageBtn" class="ghost">Scan Image</button>
        <div style="flex:1" class="small">If camera doesn't work: upload a QR image and click "Scan Image".</div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Last scan:</div>
        <div id="lastScan" style="margin-top:6px;font-weight:700">— none yet —</div>
      </div>
    </section>

    <!-- Records panel -->
    <aside class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div>
          <div class="small">Scanned records</div>
          <div style="font-weight:700" id="count">0</div>
        </div>
        <div class="actions">
          <button id="clearBtn" class="ghost">Clear</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="manualName" type="text" placeholder="Full name (manual)" />
          <input id="manualId" type="text" placeholder="ID number (manual)" />
          <button id="addManualBtn" class="ghost">Add</button>
        </div>

        <div style="max-height:420px;overflow:auto">
          <table id="recordsTable">
            <thead><tr><th>#</th><th>Time</th><th>Name / Raw</th><th>ID</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

  <!-- Libraries: html5-qrcode for camera scan and js libraries for ease -->
  <script src="https://unpkg.com/html5-qrcode@2.3.6/minified/html5-qrcode.min.js"></script>

  <script>
  (function(){
    // in-memory record list
    const records = [];

    // DOM refs
    const readerDiv = document.getElementById('reader');
    const startScanBtn = document.getElementById('startScanBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const scanImageBtn = document.getElementById('scanImageBtn');
    const fileInput = document.getElementById('fileInput');
    const lastScan = document.getElementById('lastScan');
    const recordsTableBody = document.querySelector('#recordsTable tbody');
    const countEl = document.getElementById('count');
    const clearBtn = document.getElementById('clearBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const addManualBtn = document.getElementById('addManualBtn');
    const manualName = document.getElementById('manualName');
    const manualId = document.getElementById('manualId');

    let html5QrCode = null;
    let cameraId = null;
    let scanning = false;

    // Utility: timestamp
    function nowTs(){ return new Date().toISOString(); }
    function prettyTime(){ return new Date().toLocaleString(); }

    // Add record object and refresh UI
    function addRecord(obj){
      // obj: { rawText, fullName?, idNumber?, parsed: bool, ts }
      records.unshift(obj);
      renderRecords();
      lastScan.textContent = (obj.fullName? `${obj.fullName} — ${obj.idNumber || 'ID?'} ` : obj.rawText) + ` (${new Date(obj.ts).toLocaleTimeString()})`;
    }

    // Render table
    function renderRecords(){
      recordsTableBody.innerHTML = '';
      records.forEach((r,i)=>{
        const tr = document.createElement('tr');
        const idxTd = document.createElement('td'); idxTd.textContent = records.length - i;
        const tsTd = document.createElement('td'); tsTd.textContent = new Date(r.ts).toLocaleString();
        const nameTd = document.createElement('td'); nameTd.textContent = r.fullName || r.rawText || '—';
        const idTd = document.createElement('td'); idTd.textContent = r.idNumber || '—';
        tr.appendChild(idxTd); tr.appendChild(tsTd); tr.appendChild(nameTd); tr.appendChild(idTd);
        recordsTableBody.appendChild(tr);
      });
      countEl.textContent = records.length;
    }

    // Try parse JSON payload
    function parsePayload(text){
      let parsed = null;
      try{
        parsed = JSON.parse(text);
      }catch(e){
        parsed = null;
      }
      if(parsed && (parsed.fullName || parsed.idNumber)){
        return { parsed:true, fullName: parsed.fullName || '', idNumber: parsed.idNumber || '', rawText: text };
      }
      return { parsed:false, rawText:text };
    }

    // Camera scanning using html5-qrcode
    async function startCamera(){
      if(scanning) return;
      try{
        // request cameras
        const devices = await Html5Qrcode.getCameras();
        // prefer back camera
        cameraId = devices && devices.length ? (devices.find(d=>/back|rear|environment/i.test(d.label))?.id || devices[0].id) : null;
        if(!cameraId) {
          alert('No camera found. Use the image upload option instead.');
          return;
        }

        // create instance if needed
        if(!html5QrCode){
          html5QrCode = new Html5Qrcode(/* element id */ "reader", { fps: 10, qrbox: 250 });
        }

        await html5QrCode.start(
          cameraId,
          {
            fps: 10, // frames per second
            qrbox: { width: 240, height: 240 }
          },
          qrCodeMessage => {
            // onSuccess callback when QR is decoded
            const parsed = parsePayload(qrCodeMessage);
            const record = {
              ts: nowTs(),
              rawText: parsed.rawText,
              fullName: parsed.fullName || null,
              idNumber: parsed.idNumber || null,
              parsed: parsed.parsed || false
            };
            addRecord(record);
            // small visual feedback
            flashReader();
          },
          errorMessage => {
            // no-op (scanning ongoing)
          }
        );
        scanning = true;
        startScanBtn.disabled = true;
        stopScanBtn.disabled = false;
        startScanBtn.textContent = 'Camera running';
      }catch(err){
        console.error(err);
        alert('Failed to access camera: ' + (err && err.message ? err.message : err));
      }
    }

    async function stopCamera(){
      if(html5QrCode && scanning){
        await html5QrCode.stop();
        html5QrCode.clear();
      }
      scanning = false;
      startScanBtn.disabled = false;
      stopScanBtn.disabled = true;
      startScanBtn.textContent = 'Start Camera';
      readerDiv.innerHTML = 'Camera stopped';
    }

    // small flash effect
    function flashReader(){
      readerDiv.style.boxShadow = '0 0 0 4px rgba(197,157,47,0.25)';
      setTimeout(()=> readerDiv.style.boxShadow = 'none', 200);
    }

    // Scan uploaded image using html5-qrcode's scanFileV2 (safe fallback)
    async function scanImageFile(file){
      if(!file) return alert('Choose an image with a QR code first.');
      try{
        const html5 = html5QrCode || new Html5Qrcode("reader");
        const result = await html5.scanFileV2(file, true);
        // result can be an array of decoded info
        const decoded = result.decodedText || (Array.isArray(result) && result[0] && result[0].decodedText) || result;
        if(!decoded) throw new Error('No QR code found in that image.');
        const parsed = parsePayload(decoded);
        addRecord({ ts: nowTs(), rawText: parsed.rawText, fullName: parsed.fullName || null, idNumber: parsed.idNumber || null, parsed: parsed.parsed || false });
      }catch(err){
        console.error(err);
        alert('Could not decode image: ' + (err.message || err));
      }
    }

    // Export CSV
    function exportCSV(){
      if(records.length === 0) return alert('No records to export.');
      const header = ['timestamp','fullName','idNumber','rawText'];
      const rows = records.map(r => [r.ts, r.fullName ? r.fullName.replace(/"/g,'""') : '', r.idNumber ? r.idNumber.replace(/"/g,'""') : '', r.rawText ? r.rawText.replace(/"/g,'""') : '']);
      const csv = [header.join(','), ...rows.map(r=> r.map(c=> `"${c}"`).join(','))].join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `samagfil_scans_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Clear records
    function clearRecords(){
      if(!confirm('Clear all recorded scans?')) return;
      records.length = 0;
      renderRecords();
      lastScan.textContent = '— none yet —';
    }

    // Manual add
    function addManual(){
      const fullName = manualName.value.trim();
      const idNumber = manualId.value.trim();
      if(!fullName && !idNumber) return alert('Enter name or ID to add manually.');
      addRecord({ ts: nowTs(), rawText: `${fullName} / ${idNumber}`, fullName: fullName || null, idNumber: idNumber || null, parsed: true });
      manualName.value = '';
      manualId.value = '';
    }

    // Events wiring
    startScanBtn.addEventListener('click', startCamera);
    stopScanBtn.addEventListener('click', stopCamera);
    scanImageBtn.addEventListener('click', ()=> {
      const f = fileInput.files && fileInput.files[0];
      scanImageFile(f);
    });
    exportCsvBtn.addEventListener('click', exportCSV);
    clearBtn.addEventListener('click', clearRecords);
    addManualBtn.addEventListener('click', addManual);

    // initial render
    renderRecords();

    // optional: try to auto-start camera on mobile (silent if blocked)
    // (commented out by default)
    // startCamera();

  })();
  </script>
</body>
</html>
